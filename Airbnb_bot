const express = require('express');
const puppeteer = require('puppeteer-core');
const fs = require('fs');

const app = express();

app.get('/inbox', async (req, res) => {
  const browser = await puppeteer.launch({ headless: true });
  const page = await browser.newPage();

  const cookies = JSON.parse(fs.readFileSync('./cookies.json'));
  await page.setCookie(...cookies);

  await page.goto('https://www.airbnb.com/inbox', { waitUntil: 'networkidle2' });

  const messages = await page.evaluate(() => {
    return [...document.querySelectorAll('[data-testid="inbox-thread-card"]')].map(card => ({
      guest: card.querySelector('h3')?.innerText,
      message: card.querySelector('p')?.innerText,
      time: card.querySelector('time')?.innerText,
    }));
  });

  await browser.close();
  res.json(messages);
});

app.listen(3000, () => console.log('Bot running on port 3000'));
